var fs        = require('fs'),
    del       = require('del'),
    gulp      = require('gulp'),
    gbump     = require('gulp-bump'),
    gjshint   = require('gulp-jshint'),
    ggit      = require('gulp-git'),
    gmocha    = require('gulp-mocha'),
    gshell    = require('gulp-shell')
    gsize     = require('gulp-size'),
    gutil     = require('gulp-util'),
    gwebpack  = require('gulp-webpack'),
    path      = require('path'),
    webpack   = require('webpack'),
    uglify    = require('uglify-js');

var paths = {    
  ENTRY:    './index.js',
  FILE:     'mmeddle.js',
  FILE_MIN: 'mmeddle.min.js',
  FILE_MAP: 'mmeddle.map',
  HEADER:   './src/header.js',
  VERSION:  './src/version.js',
  DIST:     './dist',
  REF_SRC:  './src/function/',
  REF_DEST: './docs/reference/functions/',

  images: 'images/**/*',
  src: ['index.js', 'src/**/*.js'],
  allsrc: ['test/**/*.js', 'index.js', 'src/**/*.js'],
  tests: 'test/**/*.js'
};

paths.MMEDDLE_JS     = path.join(paths.DIST, paths.FILE);
paths.MMEDDLE_MIN_JS = path.join(paths.DIST, paths.FILE_MIN);
paths.MMEDDLE_MAP_JS = path.join(paths.DIST, paths.FILE_MAP);
    
// generate banner with today's date and correct version
function createBanner() {
  var today = gutil.date(new Date(), 'yyyy-mm-dd'); // today, formatted as yyyy-mm-dd
  var version = require('./package.json').version;
  gutil.log('createBanner:' + paths.MMEDDLE_JS);
  return String(fs.readFileSync(paths.HEADER))
      .replace('@@date', today)
      .replace('@@version', version);
}

// generate a js file containing the version number
function updateVersionFile() {
  gutil.log('updateVersionFile:' + paths.MMEDDLE_JS);
  var version = require('./package.json').version;

  // generate file with version number
  fs.writeFileSync(paths.VERSION, 'module.exports = \'' + version + '\';\n' +
      '// Note: This file is automatically generated when building mmeddle.js.\n' +
      '// Changes made in this file will be overwritten.\n');
}

var bannerPlugin = new webpack.BannerPlugin(createBanner(), {
  entryOnly: true,
  raw: true
});

gulp.task('bundle', ['validate'], function () {
  // update the banner contents (has a date in it which should stay up to date)
  gutil.log('bundle:' + paths.MMEDDLE_JS);
  bannerPlugin.banner = createBanner();
  updateVersionFile();
  return gulp.src(paths.ENTRY)
    .pipe(gwebpack({
        output: {
          library: 'mmeddle',
          libraryTarget: 'umd',
          filename: paths.FILE
        },
        externals: [
          // 'crypto' // is referenced by decimal.js
        ],
        plugins: [ bannerPlugin ],
        cache: true
      }, null,
      function(err, stats) {
        if (err) {
          gutil.log('******************NOT bundled ' + paths.MMEDDLE_JS);
          gutil.log(err);
        }
        gutil.log('bundled ' + paths.MMEDDLE_JS);
      }))
    .pipe(gsize({ title: "Full source browser script: " + paths.MMEDDLE_JS }))
    .pipe(gulp.dest(paths.DIST));
});

gulp.task('minify', ['bundle'], function () {
  var result = uglify.minify([paths.MMEDDLE_JS], {
      outSourceMap: paths.FILE_MAP,
      output: {
        comments: /@license/
      }
    });
  fs.writeFileSync(paths.MMEDDLE_MIN_JS, result.code);
  fs.writeFileSync(paths.MMEDDLE_MAP_JS, result.map);
  gutil.log('Minified ' + paths.MMEDDLE_MIN_JS);
  gutil.log('Mapped ' + paths.MMEDDLE_MAP_JS);
  return gulp.src(paths.MMEDDLE_MIN_JS)
         .pipe(gsize({ title: "Minimized browser script: " + paths.MMEDDLE_MIN_JS }));
});

// test various item for consistency
gulp.task('validate', function (cb) {
  gutil.log('validate:' + paths.MMEDDLE_JS);
  // A no-op for now.
  gutil.log('validated:' + paths.MMEDDLE_JS);
  cb();
});

gulp.task('lint', function () {
  return gulp.src(paths.src)
    .pipe(gjshint('.jshintrc'))
    .pipe(gjshint.reporter('jshint-stylish'));
});

// Run the PhantomJS browser based tests a bit indirectly.
gulp.task('testb', ['bundle', 'minify'], gshell.task([
  'npm run-script testb'
]))

// Run the Istanbul code coverage reporter based on the mocha tests.
gulp.task('coverage', gshell.task([
  'npm run-script coverage'
]))

gulp.task('docs', gshell.task([
  'npm run-script docs'
]))

// Open generated web pages 
gulp.task('showcoverage', gshell.task([
  path.join('.', 'coverage', 'lcov-report', 'index.html')
], { ignoreErrors: true }))

gulp.task('showdocs', gshell.task([
  path.join('.', 'docs', 'src', 'index.html')
], { ignoreErrors: true }))

// Run Mocha tests on all test.*js files.
gulp.task('test', function () {
    return gulp.src(paths.tests, {read: false})
        .pipe(gmocha({
          ui: 'bdd',
          //reporter: 'nyan'
          //reporter: 'progress'
          reporter: 'dot'
          // reporter: 'min' 
          //reporter: 'spec'
        }));
});  

gulp.task('clean', function (cb) {
  del([path.join(paths.DIST, '*')], function(err, deletedFiles) {
    if (deletedFiles.length > 0) {
      gutil.log('Files deleted:', deletedFiles.join(', '));
    }
    else {
      gutil.log('No files deleted.');
    }
    cb();
  });
});

gulp.task('bump', function () {
  return gulp.src(['./package.json', './bower.json'])
    .pipe(gbump())
    .pipe(gulp.dest('./'));
});

// Commit, tag and push changes to the master branch in GitHub.
gulp.task('commit-tag-push', function () {
  var version = require('./package.json').version;
  var v = 'v' + version;
  var message = 'Release ' + v; 
  
  // Make the message more interesting using an environment variable.
  if (process.env.GIT_COMMIT_MESSAGE) {
    message += ' - ' + process.env.GIT_COMMIT_MESSAGE;
  }

  gutil.log('Commit Tag and Push as: "' + message + '"');
  return gulp.src('./')
    .pipe(ggit.commit(message))
    .pipe(ggit.tag(v, message))
    .pipe(ggit.push('origin', 'master', '--tags'))
    .pipe(gulp.dest('./'));
});

// Publish the package to NPM.
gulp.task('npm', function (done) {
  require('child_process').spawn(
    'npm',
      ['publish'],
      {
        stdio: 'inherit'
      }
    ).on('close', done);
});

// The default task (called when you run `gulp`)
gulp.task('default', ['test', 'lint', 'clean', 'bundle', 'minify', 'testb', 'docs']);

// Watch task to automatically test and rebuild when the source code changes
gulp.task('watch', ['minify'], function () {
  // Just do tests while watching.
  gulp.watch(paths.allsrc, ['test', 'lint']);
});
